From 2b690fb67b3108e09190c06be217f6b21e5241eb Mon Sep 17 00:00:00 2001
From: Yehonal <yehonal.azeroth@gmail.com>
Date: Thu, 22 Dec 2016 13:31:56 +0100
Subject: [PATCH 14/26] various fixes

---
 src/components/game/chat/index.jsx |  4 ++++
 src/lib/game/chat/handler.js       | 11 +++++++++++
 src/lib/game/handler.js            |  2 +-
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/components/game/chat/index.jsx b/src/components/game/chat/index.jsx
index 54c375b..fabdefa 100644
--- a/src/components/game/chat/index.jsx
+++ b/src/components/game/chat/index.jsx
@@ -161,6 +161,7 @@ class ChatPanel extends React.Component {
                 </TabList>
                 <TabPanel>
                       <ul id="sayMessages" className="chat-box">
+                        <li>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</li>
                         { this.state.sayMessages.map((message, index) => {
                           const className = classes('message', message.kind);
                           return (
@@ -181,6 +182,7 @@ class ChatPanel extends React.Component {
                 </TabPanel>
                 <TabPanel>
                       <ul id="guildMessages" className="chat-box">
+                        <li>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</li>
                         { this.state.guildMessages.map((message, index) => {
                           const className = classes('message', message.kind);
                           return (
@@ -202,6 +204,7 @@ class ChatPanel extends React.Component {
                 </TabPanel>
                 <TabPanel>
                       <ul id="worldMessages" className="chat-box">
+                        <li>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</li>
                         { this.state.worldMessages.map((message, index) => {
                           const className = classes('message', message.kind);
                           return (
@@ -223,6 +226,7 @@ class ChatPanel extends React.Component {
                 </TabPanel>
                 <TabPanel>
                       <ul id="logsMessages" className="chat-box">
+                        <li>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</li>
                         { this.state.logsMessages.map((message, index) => {
                           const className = classes('message', message.kind);
                           return (
diff --git a/src/lib/game/chat/handler.js b/src/lib/game/chat/handler.js
index 27a34e9..4cee538 100644
--- a/src/lib/game/chat/handler.js
+++ b/src/lib/game/chat/handler.js
@@ -161,42 +161,53 @@ class ChatHandler extends EventEmitter {
 
     const message = null;
 
+    var chatLimit=300;
+
     switch(type) {
         case ChatEnum.CHAT_MSG_SAY:
             message = new Message("area", text, guid1.low);
             this.sayMessages.push(message);
+            this.sayMessages.length > chatLimit && this.sayMessages.shift();
         break;
         case ChatEnum.CHAT_MSG_SYSTEM:
             message = new Message("system", text, 0); // hardcoded guid
             this.sayMessages.push(message);
+            this.sayMessages.length > chatLimit && this.sayMessages.shift();
         break;
         case ChatEnum.CHAT_MSG_EMOTE:
             message = new Message("me", text, guid1.low);
             this.sayMessages.push(message);
+            this.sayMessages.length > chatLimit && this.sayMessages.shift();
         break;
         case ChatEnum.CHAT_MSG_YELL:
             message = new Message("yell", text, guid1.low);
             this.sayMessages.push(message);
+            this.sayMessages.length > chatLimit && this.sayMessages.shift();
         break;
         case ChatEnum.CHAT_MSG_GUILD:
             message = new Message("guild", text, guid1.low);
             this.guildMessages.push(message);
+            this.guildMessages.length > chatLimit && this.guildMessages.shift();
         break;
         case ChatEnum.CHAT_MSG_CHANNEL:
             message = new Message("channel", text, guid1.low);
             this.worldMessages.push(message);
+            this.worldMessages.length > chatLimit && this.worldMessages.shift();
         break;
         case ChatEnum.CHAT_MSG_WHISPER:
             message = new Message("whisper incoming", text, guid1.low, guid2.low);
             this.sayMessages.push(message);
+            this.sayMessages.length > chatLimit && this.sayMessages.shift();
         break;
         case ChatEnum.CHAT_MSG_WHISPER_FOREIGN:
             message = new Message("whisper incoming", text, senderName, recvGuid.low);
             this.sayMessages.push(message);
+            this.sayMessages.length > chatLimit && this.sayMessages.shift();
         break;
         default:
             message = new Message("info", text, guid1.low);
             this.logsMessages.push(message);
+            this.logsMessages.length > chatLimit && this.logsMessages.shift();
         break;
     }
 
diff --git a/src/lib/game/handler.js b/src/lib/game/handler.js
index 585a5c2..123744c 100644
--- a/src/lib/game/handler.js
+++ b/src/lib/game/handler.js
@@ -160,7 +160,7 @@ class GameHandler extends Socket {
         //playerClass : playerClass
     };
     
-    this.emit("message",null); // to refresh
+    this.session.chat.emit("message",null); // to refresh
   }
   
   askName(guid) {
-- 
2.43.0

